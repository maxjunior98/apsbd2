/// FUNCAO DE BUSCA POR DADOS DE PRODUTO

CREATE OR REPLACE FUNCTION GETPRODUTO (PID INT)
RETURN TABLE(QUANTIDADE INT, CATEGORIA VARCHAR(16), LOJAID INT, PRECO VARCHAR(8), NOME VARCHAR(100)) AS $$
BEGIN
	RETURN QUERY
		SELECT P.QUANTIDADE, P.CATEGORIA, P.IDLOJA, P.PRECO, P.NOME FROM PRODUTOS P
		WHERE IDPRODUTO = PID;
END;
$$ LANGUAGE PLPGSQL



/// FUNCAO DE ATUALIZAR VALOR PRINCIPAL DE ENDERECOS ASSOCIADOS A UMA CONTA

CREATE OR REPLACE FUNCTION atualizarPrincipalEnd (iduser int)
returns VOID AS $$
DECLARE
CEPATT VARCHAR(8);
STAT bool;
BEGIN
	SELECT CEP INTO CEPATT FROM CLIENTES 
	WHERE IDCONTA = IDUSER;
	SELECT PRINCIPAL INTO STAT FROM ENDERECOS
	WHERE CEP = CEPATT;
	IF STAT = TRUE THEN
		UPDATE ENDERECOS SET PRINCIPAL = FALSE
		WHERE CEP = CEPATT;
	ELSE
		UPDATE ENDERECOS SET PRINCIPAL = TRUE
		WHERE CEP = CEPATT;
	END IF;
	RAISE NOTICE 'ENDERECO PRINCIPAL ATUALIZADO';
EXCEPTION
	WHEN NO_DATA_FOUND THEN
		RAISE NOTICE 'NÃO EXISTE ESTE CLIENTE';
END;
$$ language plpgsql


/// VISUALIZAR NUMERO TOTAL DE PEDIDOS DE UMA CONTA

CREATE OR REPLACE FUNCTION GETPEDIDOS (IDACC INT)
RETURNS int AS $$
DECLARE
NUMPEDIDOS INT;
BEGIN 
	SELECT COUNT(*) INTO NUMPEDIDOS FROM PEDIDOS
	WHERE IDCONTA = IDACC;
	RETURN NUMPEDIDOS;
END;
$$ LANGUAGE PLPGSQL
